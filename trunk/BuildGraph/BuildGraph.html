<html>
	<head>
		<link href="https://code.jquery.com/ui/1.11.4/themes/black-tie/jquery-ui.css" rel="stylesheet">	
		<link href="node_modules/touch-splitter-jquery/src/touchsplitter.css" rel="stylesheet">	
		<link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.7.0/vis.min.css" rel="stylesheet">
		
		<script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
		<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>
		
		<script src="node_modules/touch-splitter-jquery/src/jquery.touchsplitter.js"></script>		
		
		<script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.7.0/vis.min.js"></script>
		
		<script src="http://tinymce.cachefly.net/4.2/tinymce.min.js"></script>
		
		<script src="plantillas.js"></script>
		
		<style>
			.splitter-bar {
				background: black;
				width: 5px !important;
			}
			#instruccionesejercicio{
				width:100%;
				height:75%;
			}
		</style>
		<script>
			var tree={};
			var graphData = {};
			var graphEdges = {};
			var paso = -1;
			var padre = -1;
			var idEdge=0;
			
			function setViewLayout(control, view){
				if (view){
					control.show();
					$("#btnGuardar").show();
				}else{
					control.hide();
					$("#btnGuardar").hide();
				}
			}
			
			function loadDataLayoutInformacion (datos){
				$("#id").val(datos.id);
				$("#instruccionesejercicio").val(datos.instruccionesejercicio);
			}
			
			function loadDataLayoutPaso (datos){
				$("#paso").val(datos.paso);
				$("#tipopaso").val(datos.tipo);
				$("#instruccion").val(datos.instruccion);
				tinyMCE.get("presentacion").setContent(datos.presentacion);
				$("#neutral").val(datos.textoEmocional.neutral);
				$("#encantado").val(datos.textoEmocional.encantado);
				$("#sorprendido").val(datos.textoEmocional.sorprendido);
				$("#compasivo").val(datos.textoEmocional.compasivo);
				$("#esceptico").val(datos.textoEmocional.esceptico);
				$("#positiva").val(datos.textoEmocional.retroalimentacion.positiva);
				$("#retroalimentacionNeutral").val(datos.textoEmocional.retroalimentacion.neutral);
				$("#negativa").val(datos.textoEmocional.retroalimentacion.negativa);
			}
			
			function limpiarControles(){
				$("#informacion input[type='text']").val("");
				$("#informacion input[type='number']").val("-1");
				$("#informacion select").prop("selectedIndex",0);
				$("#informacion textarea").val("");
				tinyMCE.get("presentacion").setContent("");
			};
			
			function desactivarBotones(activar){
				$("#btnAgregar").prop("disabled",activar);
				$("#btnEliminar").prop("disabled",activar);
			}
			
			$(document).ready(function(){
				$('.split-me').touchSplit({leftMin:100,dock:"left"});
				
				tinymce.init({selector:"#presentacion"});
				
				setViewLayout($("#layoutPaso"),false);
				setViewLayout($("#layoutInformacion"),true);
				
				graphData = new vis.DataSet();
				
				graphEdges = new vis.DataSet();
				
				tree = new vis.Network(
					document.getElementById("graphExampleTracing"),
					{ //Data
						nodes: graphData,
						edges : graphEdges
					},
					{
						interaction:{
							dragNodes:false
						},
						layout:{
							hierarchical:{
								enabled: true,
								sortMethod:"directed"
							}
						}
					}//Options
				);
				
				tree.on("selectNode",function(n){
					desactivarBotones(false);
				});
				
				tree.on("deselectNode",function(n){
					desactivarBotones(true);
				});
				
				tree.on("doubleClick",function(event){
					//Obtener nodo
					if (event.nodes.length > 0){
						var nodo = graphData.get(event.nodes[0]);
						paso = nodo.id;
						
						if (paso==-1){
							setViewLayout($("#layoutInformacion"),true);
							loadDataLayoutInformacion(nodo.datos);
						}else{
							addEdge = false;
							setViewLayout($("#layoutPaso"),true);
						}
					}
				});
				
				$("#btnGuardar").click(function(){
					if ($("#paso").val()!="-1"){
						paso = $("#paso").val();
					}
					//Guardar en dataset
					if (paso==-1){
						graphData.update({
							id:-1,
							label:"Paso: -1",
							datos:{
								id:$("#id").val(),
								paso:"-1",
								tipo:"instruccionesejercicio",
								instruccionesejercicio:$("#instruccionesejercicio").val(),
							}
						});
						setViewLayout($("#layoutInformacion"),false);
					} else{
						//Crear o actualizar nodo
						graphData.update({
							id: paso,
							label: "Paso "+paso,
							datos:{
								paso:paso,
								tipo: $("#tipopaso").val(),
								instruccion: $("#instruccion").val(),
								presentacion: tinyMCE.get("presentacion").getContent(),
								textoEmocional: {
									neutral: $("#neutral").val(),
									encantado: $("#encantado").val(),
									sorprendido: $("#sorprendido").val(),
									compasivo: $("#compasivo").val(),
									esceptico: $("#esceptico").val(),
									retroalimentacion: {
										positiva: $("#positiva").val(),
										neutral: $("#retroalimentacionNeutral").val(),
										negativa: $("#negativa").val()
									} 
								}
							}
						});
						if (addEdge){
							//Crear enlace
							graphEdges.update({
								id: ++idEdge,
								from: padre,
								to: paso
							});
						}
						setViewLayout($("#layoutPaso"),false);
					}
					limpiarControles();
				});
				
				$("#btnAgregar").click(function(){
					setViewLayout($("#layoutPaso"), true);
					padre = tree.getSelectedNodes()[0];
					addEdge = true;
				});
			});
			
		</script>
	</head>
	<body>
		<div class="split-me-container">
			<div class="split-me">
				<div>
					<div id="graphExampleTracing">
					</div>
				</div>
				<div>
					<div>
						<button id="btnAgregar" disabled >Agregar</button>
						<button id="btnEliminar" disabled >Eliminar</button>
						<button id="btnCargar" >Cargar</button>
						<button id="btnObtenerJSON">Obtener JSON</button>
					</div>
					<hr>
					<div id="informacion">
						<div id="layoutInformacion">
							<label>Id</label>
							<input type="number" id="id" value="0">
							<button disabled>Obtener Id</button><br>
							<label>Instrucciones del Ejercicio</label><br>
							<textarea id="instruccionesejercicio"></textarea><br>
						</div>
						<div id="layoutPaso">
							<label>Paso</label>
							<input type="number" id="paso" value="-1"><br>
							<label>Tipo</label>
							<select id="tipopaso">
								<option value="pasoinicial">Paso Inicial</option>
								<option value="pasooptimo">Paso Optimo</option>
								<option value="pasosuboptimo">Paso SubOptimo</option>
								<option value="pasoerroneo">Paso Erroneo</option>
								<option value="pasofinalsuboptimo">Paso Final SubOptimo</option>
								<option value="pasofinaloptimo">Paso Final Optimo</option>
							</select><br>
							<label>Instruccion</label>
							<textarea id="instruccion"></textarea>
							<label>Presentacion</label><br>
							<textarea id="presentacion"></textarea>
							<div id="informacionEmocional">
								Texto Emocional<br>
								<label>Neutral</label>
								<input id="neutral" type="text"><br>
								<label>Encantado</label>
								<input id="encantado" type="text"><br>
								<label>Sorprendido</label>
								<input id="sorprendido" type="text"><br>
								<label>Compasivo</label>
								<input id="compasivo" type="text"><br>
								<label>Esceptico</label>
								<input id="esceptico" type="text"><br>
								<div>
									Retroalimentacion<br>
									<label>Positiva</label>
									<input id="positiva" type="text"><br>
									<label>Neutral</label>
									<input id="retroalimentacionNeutral" type="text"><br>
									<label>Negativa</label>
									<input id="negativa" type="text"><br>
								</div>
							</div>
						</div>
						<button id="btnGuardar">Guardar</button>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
